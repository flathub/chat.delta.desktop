app-id: chat.delta.desktop
base: org.electronjs.Electron2.BaseApp
base-version: '20.08'
runtime: org.freedesktop.Platform
runtime-version: '20.08'
sdk: org.freedesktop.Sdk
sdk-extensions:
  - org.freedesktop.Sdk.Extension.node12
command: /app/bin/run.sh
finish-args:
  - --socket=x11
  - --share=ipc
  - --device=dri         # Without DRI the app doesn't come up :-/
  - --device=all         # Webcam access for QR code scans
  - --socket=pulseaudio  # Record and play voice messages
  - --filesystem=home
  - --share=network
  - --talk-name=org.freedesktop.Notifications
        
modules:
  # Copied from https://github.com/flatpak/flatpak-builder-tools/blob/ca5863a21454e81b04218f22cea83b2f78abed0b/node/vanilla-quick-start/org.electronjs.ElectronQuickStart.yaml#L31
  - name: node
    buildsystem: simple
    build-commands:
      - '/usr/lib/sdk/node12/install-sdk.sh'

  - deltachat-core-rust.yaml

  - name: delta
    buildsystem: simple
    build-options:
      append-path: /usr/lib/sdk/node12/bin
      env:      
        NPM_CONFIG_LOGLEVEL: info
        npm_config_nodedir: /usr/lib/sdk/node12

        # Tell caches where we pre-downloaded things.
        npm_config_cache: /run/build/delta/flatpak-node/npm-cache/
        electron_config_cache: /run/build/delta/flatpak-node/cache/electron
        
        # for electron builder
        ELECTRON_CACHE: /run/build/delta/flatpak-node/cache/electron

        XDG_CACHE_HOME: /run/build/delta/flatpak-node/cache

        # Taken from https://github.com/flathub/com.visualstudio.code-oss/blob/bd6d8052cbbd63a53396f4caad86adf73ec455cf/com.visualstudio.code-oss.yml#L71
        ESBUILD_BIN_PATH_FOR_TESTS: /run/build/delta/flatpak-node/cache/esbuild/bin/esbuild-current

        # This overwrites the git-ref version info for the about- and crash-screen
        VERSION_INFO_GIT_REF: "flathub"

    build-commands:
      - node --version
      - npm --version
      # electron builder symlink workaround
      - cd $ELECTRON_CACHE && ln -s httpsgithub.comelectronelectronreleasesdownloadv*.zip/*.zip $(echo httpsgithub.comelectronelectronreleasesdownloadv*.zip | sed -e s/.*electron/electron/) && cd -
   
      - npm cache verify
      - mkdir -p $FLATPAK_BUILDER_BUILDDIR/flatpak-node/tmp
      # https://github.com/flatpak/flatpak-builder-tools/blob/db24c70456b7122f4243ab4a21dbb3368334e259/node/README.md#chromedriver-support
      - env TMPDIR=$FLATPAK_BUILDER_BUILDDIR/flatpak-node/tmp DEBUG="*" npm install --offline --verbose --dc-system-lib=true
      - npm run build4production --offline --verbose
      - env NO_ASAR=true  npm run pack:generate_config --offline --verbose
      - npm run pack:linux:dir --offline --verbose
      - mkdir -p /app/delta
      - cp -ar dist/linux-unpacked/* /app/delta/

      # Install the required static files
      - install run.sh /app/bin/run.sh
      - install -Dm 0644 chat.delta.desktop.desktop  /app/share/applications/chat.delta.desktop.desktop
      - install -Dm 0644 static/chat.delta.desktop.appdata.xml  /app/share/metainfo/chat.delta.desktop.appdata.xml
      - install -Dm 0644 delta-v7-pathed.svg /app/share/icons/hicolor/scalable/apps/chat.delta.desktop.svg
    sources:
      # Electron
      # the binaries are already included in generated-sources-npm.0.json

      # Delta Chat
      - type: git
        url: https://github.com/deltachat/deltachat-desktop.git
        tag: v1.20.2
        commit: 0c548cbd909bed66de812b16b8fbb3f8c45bc158

      - type: file
        url: https://raw.githubusercontent.com/deltachat/interface/970c5df39866695b5e8ebdd73caa68cbb6de5242/icons/delta-v7-pathed.svg
        sha256: 1787a9dfdd80301ae5dbe48105bd58215c6552bd8ecfa4efd15fe6d31ba31274
        dest-filename: delta-v7-pathed.svg

      - type: file
        path: chat.delta.desktop.desktop

      - type: file
        path: chat.delta.desktop.256.png
        dest-filename: chat.delta.desktop.png

      - type: script
        dest-filename: run.sh
        commands:
          - export TMPDIR="$XDG_RUNTIME_DIR/app/$FLATPAK_ID"
          - exec zypak-wrapper /app/delta/deltachat-desktop "$@"


      # All the generated npm downloads, see README.md how to create
      # this file.  This needs to go to the bottom so that the
      # commands in that file can see package.json and friends.
      - generated-sources-npm.0.json


      # https://github.com/deltachat/deltachat-desktop/pull/1125
      - type: file
        dest: static
        path: chat.delta.desktop.appdata.xml

