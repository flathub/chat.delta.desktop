name: deltachat-core-rust
buildsystem: simple
build-options:
  env:
    # It does not work to dereference the variable here :-/
    # CARGO_HOME: $FLATPAK_BUILDER_BUILDDIR/cargo
    CARGO_HOME: /run/build/deltachat-core-rust/cargo

    # deltachat-ffi/build.rs uses this to create deltachat.pc,
    # should locate deltachat.so.
    PREFIX: /app/lib

    # The intention is to have a release build with debugging symbols.
    # The flatpak build process should separate the debug symbols.
    RUSTFLAGS: "-g"

    # sccache hopefully speeds up subsequent compilations
    RUSTC_WRAPPER: /app/bin/sccache
    SCCACHE_DIR: /run/ccache/sccache/

  append-path: /app/lib/sdk/rust-nightly/bin

cleanup:
    - /include
    - /lib/libdeltachat.a
build-commands:
  - type -a rustc
  - type -a cargo
  - rustc --version
  # If "fetch" doesn't work while being offline, then the build is unlikely to work either.
  - cargo --offline -Z unstable-options fetch --manifest-path deltachat-ffi/Cargo.toml  --verbose --verbose
  # Vendorising doesn't seem to work offline, even though fetch and building work. So don't attempt to re-vendor.
  # - cargo --offline -Z unstable-options vendor --manifest-path deltachat-ffi/Cargo.toml  --verbose
  - cargo --offline -Z unstable-options build -p deltachat_ffi --release --out-dir $PREFIX --verbose
  - install -D -m a+r deltachat-ffi/deltachat.h  /app/include/deltachat-ffi/deltachat.h
  # We shouldn't really have to patch this ourselves: https://github.com/deltachat/deltachat-core-rust/issues/2744
  - sed -i 's,/usr/local/include,/app/include/deltachat-ffi,g' ./target/release/pkgconfig/deltachat.pc
  - sed -i 's,/usr/local/,/app/,g' ./target/release/pkgconfig/deltachat.pc
  - install -D -m a+r ./target/release/pkgconfig/deltachat.pc  /app/lib/pkgconfig/deltachat.pc
  - find /app -name '*delta*.so'
  - pkg-config --libs deltachat

modules:
  - name: rust-nightly
    cleanup:
      # We don't need rust in the final application, only build-time
      - /lib/sdk/rust-nightly
    buildsystem: simple
    build-commands:
      - ./install.sh --prefix=/app/lib/sdk/rust-nightly --disable-ldconfig --verbose --without=rust-docs,rust-analyzer-preview,rust-analysis-x86_64-unknown-linux-gnu,miri-preview,llvm-tools-preview,clippy-preview
    sources:
      - type: archive
        only-arches: ["x86_64"]
        url: https://static.rust-lang.org/dist/2021-02-03/rust-nightly-x86_64-unknown-linux-gnu.tar.gz
        sha256: f105251b7b0bcd451d5cba59353a29d5daac30b61b3e8c5bb0929536b635ac94

      - type: archive
        only-arches: ["aarch64"]
        url: https://static.rust-lang.org/dist/2021-02-03/rust-nightly-aarch64-unknown-linux-gnu.tar.gz
        sha256: 1299c37205f1364d9523b8f540a623310c528cb2d90a5a09b78bc8b1aa9aa973

  - name: sccache
    buildsystem: simple
    build-commands:
        - install -Dma+rwx sccache /app/bin/sccache
    sources:
        - type: archive
          url: https://github.com/mozilla/sccache/releases/download/v0.2.15/sccache-v0.2.15-x86_64-unknown-linux-musl.tar.gz
          sha256: e5d03a9aa3b9fac7e490391bbe22d4f42c840d31ef9eaf127a03101930cbb7ca
          only-arches: ["x86_64"]

        - type: archive
          url: https://github.com/mozilla/sccache/releases/download/v0.2.15/sccache-v0.2.15-aarch64-unknown-linux-musl.tar.gz
          sha256: 90d91d21a767e3f558196dbd52395f6475c08de5c4951a4c8049575fa6894489
          only-arches: ["aarch64"]

sources:
  - type: archive
    url: https://github.com/deltachat/deltachat-core-rust/archive/1.60.0.tar.gz
    sha256: b7df115452f32822e934a8e38761e2c8b15b59e34bb3ac538ec148ddc6d51098
  - generated-sources-rust.json

